#!/bin/bash
set -e -o pipefail
source "$(dirname $0)/functions"

if [[ -z "$RD_OPTION_CONTRACT" || "$RD_OPTION_CONTRACT" == random ]]; then
	contract="$(docker exec rnode sh -c 'ls ./examples/*.rho' | sort -R | head -1)"
elif [[ "$RD_OPTION_CONTRACT" =~ ^https?:// ]]; then
	contract=/var/lib/rnode-static/rundeck-contract.rho
	logcmd curl -fsSL -o $contract "$RD_OPTION_CONTRACT"
elif [[ "$RD_OPTION_CONTRACT" != */* ]]; then
	contract="./examples/$RD_OPTION_CONTRACT"
else
	contract="$RD_OPTION_CONTRACT"
fi

if [[ -z "$contract" ]] || ! docker exec rnode test -f "$contract"; then
	echo "No such contract: '$contract'" >&2
	exit 1
fi

priv_key="$RD_OPTION_DEPLOY_KEY"
if [[ -z "$priv_key" ]]; then
	read priv_key pub_key <<<$(random_key)
fi

echo "Deploying $contract with private key $priv_key"
logcmd docker exec rnode ./bin/rnode \
	$RD_OPTION_RNODE_LAUNCHER_ARGS \
	-c /var/lib/rnode-static/rnode.conf \
	deploy \
	--phlo-limit 1000000000 \
	--phlo-price 1 \
	--private-key $priv_key \
	$RD_OPTION_RNODE_DEPLOY_ARGS \
	$contract
